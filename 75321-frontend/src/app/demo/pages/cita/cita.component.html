<ngx-spinner type="ball-atom" size="large" color="#FFFFFF">
  <p>{{titleSpinner}}</p>
</ngx-spinner>
<div class="container">
  <div class="card">
    <div class="card-header">
      <div class="row align-items-center">
        <div class="col-lg-7">
          <h3 class="mb-0">
            <i class="fa fa-calendar"></i>
            &nbsp;Lista de Citas
          </h3>
          <small>Estas son las citas registradas en el sistema.</small>
        </div>
        <div class="col-lg-5 text-end">
          <button class="btn btn-outline-primary" (click)="abrirNuevaCita()">Nueva Cita</button>
        </div>
      </div>
    </div>

    <div class="card-body">
      <div class="mb-3">
        <input type="text" class="form-control" placeholder="Buscar por nombre, apellido, estado, motivo..."
          [(ngModel)]="filtroColumna" />
      </div>

      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th>#</th>
              <th>Paciente </th>
              <th>Médico </th>
              <th>Fecha y Hora</th>
              <th>Estado</th>
              <th>Motivo</th>
              <th>Acciones</th>
            </tr>
          </thead>

          <!-- Si hay citas -->
          <tbody *ngIf="citasList.length > 0">
            <tr *ngFor="let cita of citasList | filterCitas: filtroColumna; let i = index">
              <td>{{ i + 1 }}</td>
              <td>{{ cita.paciente?.nombres }} {{ cita.paciente?.apellidos }} </td>
              <td>{{ cita.medico?.nombres }} {{ cita.medico?.apellidos }} </td>
              <td>{{ cita.fechaHora | date:'dd/MM/yyyy HH:mm' }}</td>
              <td>{{ cita.estado }}</td>
              <td>{{ cita.motivo }}</td>
              <td>
                <button class="btn btn-outline-primary btn-sm" (click)="abrirEditarCita(cita)">
                  <i class="fa fa-edit"></i> Editar
                </button>
              </td>
            </tr>
          </tbody>

          <!-- Si no hay citas -->
          <tbody *ngIf="citasList.length === 0">
            <tr>
              <td colspan="7" class="text-center">No hay citas registradas.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- MODAL CREAR/EDITAR CITA -->
<div class="modal fade" id="modalCrearCita" tabindex="-1" aria-labelledby="modalCrearCitaLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalCrearCitaLabel">{{ titleModal }}</h5>
        <button type="button" class="btn-close" (click)="closeModal()" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body">
        <form [formGroup]="form">
          <div class="row">
            <!-- Paciente -->
            <div class="mb-3">
              <label for="paciente" class="form-label">Paciente</label>
              <select formControlName="pacienteId" id="paciente" class="form-select">
                <option value="">Seleccione un paciente</option>
                <option *ngFor="let p of pacientesList" [ngValue]="p.id">
                  {{ p.nombres }} {{p.apellidos}}
                </option>
              </select>
              <div *ngIf="form.get('paciente')?.hasError('required') && form.get('paciente')?.touched"
                class="text-danger">
                El paciente es requerido.
              </div>
            </div>

            <!-- Médico -->
            <div class="mb-3">
              <label for="medico" class="form-label">Médico</label>
              <select formControlName="medicoId" id="medico" class="form-select">
                <option value="">Seleccione un medico</option>
                <option *ngFor="let m of medicosList" [ngValue]="m.id">
                  {{ m.nombres }} {{m.apellidos}}
                </option>
              </select>
              <div *ngIf="form.get('medico')?.hasError('required') && form.get('medico')?.touched" class="text-danger">
                El Medico es requerido.
              </div>
            </div>

            <!-- Fecha -->
            <div class="col-md-6 mb-3">
              <label for="fecha" class="form-label">Fecha</label>
              <input type="date" formControlName="fecha" class="form-control" id="fecha" [min]="today" />
              <div *ngIf="form.get('fecha')?.hasError('required') && form.get('fecha')?.touched" class="text-danger">
                La fecha es obligatoria.
              </div>
            </div>

            <!-- Hora -->
            <div class="col-md-6 mb-3">
              <label for="hora" class="form-label">Hora</label>
              <input type="time" formControlName="hora" class="form-control" id="hora" />
              <div *ngIf="form.get('hora')?.hasError('required') && form.get('hora')?.touched" class="text-danger">
                La hora es obligatoria.
              </div>
            </div>

            <!-- Estado -->
            <div class="col-md-6 mb-3">
              <label for="estado" class="form-label">Estado</label>
              <select formControlName="estado" class="form-select" id="estado">
                <option value="">Seleccione un estado</option>
                <option value="Pendiente">Pendiente</option>
                <option value="Confirmada">Confirmada</option>
                <option value="Cancelada">Cancelada</option>
              </select>
              <div *ngIf="form.get('estado')?.hasError('required') && form.get('estado')?.touched" class="text-danger">
                El estado es obligatorio.
              </div>
            </div>

            <!-- Motivo -->
            <div class="col-12 mb-3">
              <label for="motivo" class="form-label">Motivo</label>
              <textarea formControlName="motivo" class="form-control" id="motivo"
                placeholder="Ingrese el motivo de la cita" rows="3"></textarea>
              <div *ngIf="form.get('motivo')?.hasError('required') && form.get('motivo')?.touched" class="text-danger">
                El motivo es obligatorio.
              </div>
              <div *ngIf="form.get('motivo')?.hasError('minlength') && form.get('motivo')?.touched" class="text-danger">
                El motivo debe tener al menos 5 caracteres.
              </div>
              <div *ngIf="form.get('motivo')?.hasError('maxlength') && form.get('motivo')?.touched" class="text-danger">
                El motivo no puede superar los 200 caracteres.
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- Footer del modal -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancelar</button>
        <button type="button" class="btn btn-primary" (click)="guardarCita()" [disabled]="form.invalid">
          {{ titleBoton }}
        </button>
      </div>
    </div>
  </div>
</div>
